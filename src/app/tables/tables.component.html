<div>
  <!-- Sample Selection Header -->
  <app-sample-selection
    (sampleSelected)="onSampleSelected($event)"
    (sampleCleared)="onSampleCleared()">
  </app-sample-selection>

  <!-- List View -->
  <div *ngIf="!selectedView">
    <!-- Search Box -->
    <div class="mb-3">
      <div class="input-group">
        <span class="input-group-text">
          <i class="bi bi-search"></i>
        </span>
        <input 
          type="text" 
          class="form-control" 
          placeholder="Search categories by name or path..." 
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()">
        <button *ngIf="searchTerm" class="btn btn-outline-secondary" type="button" (click)="searchTerm = ''; onSearchChange()">
          <i class="bi bi-x"></i>
        </button>
      </div>
    </div>
    
    <p class="text-muted">Navigate through the category hierarchy to find tables. Click on categories with disclosure arrows to expand them, or click on end items to view their tables.</p>
    <p *ngIf="!selectedSample" class="text-warning">Please select a sample to view data.</p>
    
    <!-- Search Results Info -->
    <div *ngIf="searchTerm" class="alert alert-info py-2 mb-3">
      <small>
        <i class="bi bi-info-circle me-1"></i>
        Found {{ filteredCategories.length }} categor{{ filteredCategories.length !== 1 ? 'ies' : 'y' }} matching "{{ searchTerm }}"
      </small>
    </div>
    
    <!-- Category Hierarchy -->
    <div class="category-hierarchy">
      <div *ngFor="let category of getFlattenedCategories()"
           class="category-item mb-2"
           [style.margin-left.px]="category.level * 20">
        
        <!-- Expandable category (has children) -->
        <button *ngIf="category.has_children && !isEndLeaf(category)"
                class="btn btn-outline-secondary expandable-category-btn d-flex align-items-center w-100 text-start"
                (click)="expandCategory(category)"
                [disabled]="isCategoryLoading(category)">
          <span class="disclosure-icon me-3">
            <span *ngIf="isCategoryLoading(category)"><i class="bi bi-hourglass-split text-primary"></i></span>
            <i *ngIf="!isCategoryLoading(category)" class="bi bi-caret-right text-primary" [class.expanded]="isCategoryExpanded(category)"></i>
          </span>
          <div class="category-info flex-grow-1">
            <div class="category-name">{{ getCategoryTitle(category) }}</div>
            <small class="text-muted" *ngIf="getCategoryHierarchy(category).length > 0">
              {{ getCategoryHierarchy(category).join(' > ') }}
            </small>
          </div>
        </button>
        
        <!-- End leaf category (has path) -->
        <div *ngIf="isEndLeaf(category)"
             class="d-flex align-items-center category-leaf"
             style="cursor: pointer"
             (click)="selectCategory(category)">
          <span class="disclosure-icon me-3">
            <i class="bi bi-table text-primary"></i>
          </span>
          <div class="category-info flex-grow-1">
            <div class="category-name fw-bold">
              {{ getCategoryTitle(category) }}
            </div>
            <small class="text-muted" *ngIf="getCategoryHierarchy(category).length > 0">
              {{ getCategoryHierarchy(category).join(' > ') }}
            </small>
          </div>
        </div>
        
        <!-- Non-expandable, non-leaf category (fallback) -->
        <div *ngIf="!category.has_children && !isEndLeaf(category)" class="d-flex align-items-center category-leaf">
          <span class="disclosure-icon me-3 text-muted">
            <i class="bi bi-dash"></i>
          </span>
          <div class="category-info text-muted">
            <div class="category-name">{{ getCategoryTitle(category) }}</div>
            <small *ngIf="getCategoryHierarchy(category).length > 0">
              {{ getCategoryHierarchy(category).join(' > ') }}
            </small>
            <small class="d-block fst-italic">No table available</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content View -->
  <div *ngIf="selectedView">
    <!-- Category Display (similar to card style) -->
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <p class="text-muted mb-1" *ngIf="getSelectedViewHierarchy().length > 0">
            {{ getSelectedViewHierarchy().join(' > ') }}
          </p>
          <h4 class="fw-bold mb-0">{{ getSelectedViewTitle() }}</h4>
        </div>
        <div class="d-flex gap-2">
          <button class="btn" 
                  [class.btn-outline-primary]="!searchMode"
                  [class.btn-primary]="searchMode"
                  (click)="toggleSearchMode()">
            <i class="bi" [class.bi-search]="!searchMode" [class.bi-x-circle]="searchMode"></i>
            {{ searchMode ? 'Exit Search Mode' : 'Search Mode' }}
          </button>
          <button class="btn btn-secondary" (click)="backToHierarchy()">Back to List</button>
        </div>
      </div>
    </div>
    
    <!-- Search mode indicator -->
    <div *ngIf="searchMode" class="alert alert-info py-2 mb-3">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <i class="bi bi-search me-2"></i>
          <strong>Search Mode Active</strong> - Click on answer cells to add search criteria
        </div>
        <small class="text-muted">{{ searchContext.searches.length }} criteria added</small>
      </div>
      
      <!-- Display current search criteria -->
      <div *ngIf="searchContext.searches.length > 0" class="mt-2">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <small class="fw-bold">Current search criteria:</small>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-danger" (click)="clearSearchCriteria()">
              <i class="bi bi-trash me-1"></i>Clear All
            </button>
            <button class="btn btn-success" (click)="executeSearch()">
              <i class="bi bi-search me-1"></i>Search
            </button>
          </div>
        </div>
        <div class="mt-2">
          <div *ngFor="let criterion of searchContext.searches; let i = index" class="bg-light border rounded p-3 mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-medium">
                {{ getQuestionHierarchyForCriterion(criterion.questionId) }}: {{ criterion.fieldName }} = {{ criterion.value }}
              </div>
              <button class="btn btn-sm p-0 ms-2" style="width: 32px; height: 32px;" (click)="removeSearchCriterion(i)" title="Remove this criterion">
                <i class="bi bi-x text-muted fs-5"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sample selection message for table view (only show when not in search mode) -->
    <div *ngIf="!selectedSample && !searchMode" class="alert alert-warning py-2 mb-3">
      <small>
        <i class="bi bi-info-circle me-1"></i>
        Please select a sample to view data, or use search mode.
      </small>
    </div>
    
    <!-- Dynamic Bootstrap Table -->
    <div *ngIf="tableData; else rawContent">
      <!-- Loading indicator -->
      <div *ngIf="isLoadingAnswers" class="text-center mb-3">
        <div class="spinner-border spinner-border-sm me-2" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        Loading answer data...
      </div>
      
      <!-- Main heading from H1 is now shown in the header above, so remove duplicate -->
      
      <div *ngFor="let section of tableData.sections; let i = index" class="mb-5">
        <!-- H2 Section heading -->
        <h4 *ngIf="section.h2Heading && !section.h3Heading" class="mb-3">{{ section.h2Heading }}</h4>

        <!-- Hierarchical headings when both H2 and H3 exist -->
        <div *ngIf="section.h2Heading && section.h3Heading" class="mb-3">
          <!-- Only show H2 if it's different from previous section or this is the first section -->
          <h4 *ngIf="i === 0 || tableData.sections[i-1].h2Heading !== section.h2Heading" class="mb-1">{{ section.h2Heading }}</h4>
          <h5 class="mb-2 text-muted">{{ section.h3Heading }}</h5>
        </div>

        <!-- Fallback to single heading -->
        <h4 *ngIf="!section.h2Heading && section.heading" class="mb-3">{{ section.heading }}</h4>
        
        <!-- Multiple tables in this section -->
        <div *ngFor="let table of section.tables" class="mb-4">
          <table class="table table-bordered custom-table">
            <!-- Table caption -->
            <caption *ngIf="table.caption" class="caption-top fw-bold">{{ table.caption }}</caption>
            
            <thead *ngIf="table.headers && table.headers.length > 0">
              <tr>
                <th *ngFor="let header of table.headers; let headerIndex = index" 
                    class="table-secondary"
                    [attr.colspan]="table.headerSpans && table.headerSpans[headerIndex]?.colspan > 1 ? table.headerSpans[headerIndex].colspan : null"
                    [attr.rowspan]="table.headerSpans && table.headerSpans[headerIndex]?.rowspan > 1 ? table.headerSpans[headerIndex].rowspan : null">
                  {{ header }}
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of table.rows">
                <ng-container *ngFor="let cell of row.cells; let cellIndex = index">
                  <td *ngIf="(!row.spans || !row.spans[cellIndex]?.isHeader) && !row.spans?.[cellIndex]?.skip"
                      [class.clickable-cell]="isCellClickable(table, row, cellIndex)"
                      [class.search-mode-cell]="searchMode && isCellClickable(table, row, cellIndex)"
                      [attr.colspan]="row.spans && row.spans[cellIndex]?.colspan > 1 ? row.spans[cellIndex].colspan : null"
                      [attr.rowspan]="row.spans && row.spans[cellIndex]?.rowspan > 1 ? row.spans[cellIndex].rowspan : null"
                      (click)="onCellClick(table, row, cellIndex)"
                      [title]="searchMode && isCellClickable(table, row, cellIndex) ? 'Click to add search criterion' : ''">
                    <!-- HTML content (from foreach-div) -->
                    <div *ngIf="isHtmlContent(cell)" [innerHTML]="cell.content"></div>

                    <!-- Nested table content -->
                    <div *ngIf="isNestedTable(cell)" class="nested-table-container">
                      <table class="table table-sm table-bordered mb-0">
                        <thead *ngIf="cell.headers && cell.headers.length > 0">
                          <tr>
                            <th *ngFor="let nestedHeader of cell.headers" class="small table-secondary">{{ nestedHeader }}</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let nestedRow of cell.rows">
                            <td *ngFor="let nestedCell of nestedRow.cells; let nestedCellIndex = index"
                                class="small">{{ nestedCell }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                    <!-- Simple cell content -->
                    <span *ngIf="!isNestedTable(cell) && !isHtmlContent(cell) && containsHtmlTags(cell)" [innerHTML]="cell"></span>
                    <span *ngIf="!isNestedTable(cell) && !isHtmlContent(cell) && !containsHtmlTags(cell)">{{ cell }}</span>
                  </td>

                  <th *ngIf="row.spans && row.spans[cellIndex]?.isHeader && !row.spans[cellIndex]?.skip"
                      class="table-secondary"
                      [class.clickable-cell]="isCellClickable(table, row, cellIndex)"
                      [class.search-mode-cell]="searchMode && isCellClickable(table, row, cellIndex)"
                      [attr.colspan]="row.spans && row.spans[cellIndex]?.colspan > 1 ? row.spans[cellIndex].colspan : null"
                      [attr.rowspan]="row.spans && row.spans[cellIndex]?.rowspan > 1 ? row.spans[cellIndex].rowspan : null"
                      (click)="onCellClick(table, row, cellIndex)"
                      [title]="searchMode && isCellClickable(table, row, cellIndex) ? 'Click to add search criterion' : ''">
                    <!-- HTML content (from foreach-div) -->
                    <div *ngIf="isHtmlContent(cell)" [innerHTML]="cell.content"></div>

                    <!-- Nested table content -->
                    <div *ngIf="isNestedTable(cell)" class="nested-table-container">
                      <table class="table table-sm table-bordered mb-0">
                        <thead *ngIf="cell.headers && cell.headers.length > 0">
                          <tr>
                            <th *ngFor="let nestedHeader of cell.headers" class="small table-secondary">{{ nestedHeader }}</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let nestedRow of cell.rows">
                            <td *ngFor="let nestedCell of nestedRow.cells; let nestedCellIndex = index"
                                class="small">{{ nestedCell }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                    <!-- Simple cell content -->
                    <span *ngIf="!isNestedTable(cell) && !isHtmlContent(cell) && containsHtmlTags(cell)" [innerHTML]="cell"></span>
                    <span *ngIf="!isNestedTable(cell) && !isHtmlContent(cell) && !containsHtmlTags(cell)">{{ cell }}</span>
                  </th>
                </ng-container>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Fallback to raw HTML if table parsing fails -->
    <ng-template #rawContent>
      <div [innerHTML]="selectedView.content"></div>
    </ng-template>
  </div>

  <!-- Phrases Modal -->
  <!-- Phrases and Transcriptions Modal -->
  <app-phrase-transcription-modal 
    [show]="showModal"
    [answer]="modalAnswer"
    [title]="modalTitle"
    (close)="closeModal()">
  </app-phrase-transcription-modal>

  <!-- Table Not Found Modal -->
  <div class="modal fade" [class.show]="showTableNotFoundModal" [style.display]="showTableNotFoundModal ? 'block' : 'none'" 
       tabindex="-1" role="dialog" *ngIf="showTableNotFoundModal">
    <div class="modal-dialog modal-sm" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
            Table Not Available
          </h5>
          <button type="button" class="btn-close" (click)="closeTableNotFoundModal()"></button>
        </div>
        <div class="modal-body text-center">
          <p class="mb-2">This table is still being implemented.</p>
          <p class="text-muted small mb-0">Please check back later.</p>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary btn-sm" (click)="closeTableNotFoundModal()">OK</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Table Not Found Modal backdrop -->
  <div class="modal-backdrop fade" [class.show]="showTableNotFoundModal" *ngIf="showTableNotFoundModal" (click)="closeTableNotFoundModal()"></div>

  <!-- Search Value Dialog -->
  <app-search-value-dialog
    [show]="showSearchModal"
    [questionId]="searchModalQuestionId"
    [questionName]="searchModalQuestionName"
    [fieldName]="searchModalFieldName"
    [hierarchy]="searchModalHierarchy"
    (confirmed)="onSearchCriterionConfirmed($event)"
    (cancelled)="onSearchCriterionCancelled()">
  </app-search-value-dialog>

</div>
