<div>
  <!-- Sample Selection Header -->
  <app-sample-selection 
    pageTitle="Grammatical Tables"
    (sampleSelected)="onSampleSelected($event)"
    (sampleCleared)="onSampleCleared()">
  </app-sample-selection>

  <!-- List View -->
  <div *ngIf="!selectedView">
    <!-- Search Box -->
    <div class="mb-3">
      <div class="input-group">
        <span class="input-group-text">
          <i class="bi bi-search"></i>
        </span>
        <input 
          type="text" 
          class="form-control" 
          placeholder="Search tables by title, filename, or content..." 
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()">
        <button *ngIf="searchTerm" class="btn btn-outline-secondary" type="button" (click)="searchTerm = ''; onSearchChange()">
          <i class="bi bi-x"></i>
        </button>
      </div>
    </div>
    
    <p class="text-muted">This is only partial list until the entire RMS corpus is imported. Some of these table templates are not yet fully functional.</p>
    <p *ngIf="!selectedSample" class="text-danger">Please select a sample to view a table.</p>
    
    <!-- Search Results Info -->
    <div *ngIf="searchTerm" class="alert alert-info py-2 mb-3">
      <small>
        <i class="bi bi-info-circle me-1"></i>
        Found {{ filteredViews.length }} table{{ filteredViews.length !== 1 ? 's' : '' }} matching "{{ searchTerm }}"
      </small>
    </div>
    
    <div *ngFor="let view of filteredViews" class="mb-3 mt-3">
      <div class="card" 
           [style.cursor]="selectedSample ? 'pointer' : 'default'" 
           [class.bg-light]="!selectedSample"
           [class.border-secondary]="!selectedSample"
           [class.bg-white]="selectedSample"
           [class.border-primary]="selectedSample"
           (click)="selectedSample ? selectView(view) : null">
        <div class="card-body">
          <p class="card-text text-muted mb-1" *ngIf="getViewHierarchy(view).length > 0">
            {{ getViewHierarchy(view).join(' > ') }}
          </p>
          <h5 class="card-title fw-bold" [class.text-muted]="!selectedSample">{{ getViewTitle(view) }}</h5>
          <p class="card-text text-muted">{{ view.filename }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Content View -->
  <div *ngIf="selectedView">
    <!-- Category Display (similar to card style) -->
    <div class="mb-3">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <p class="text-muted mb-1" *ngIf="getViewHierarchy(selectedView).length > 0">
            {{ getViewHierarchy(selectedView).join(' > ') }}
          </p>
          <h4 class="fw-bold mb-0">{{ getViewTitle(selectedView) }}</h4>
        </div>
        <button class="btn btn-secondary" (click)="backToList()">Back to List</button>
      </div>
    </div>
    
    <!-- Dynamic Bootstrap Table -->
    <div *ngIf="tableData; else rawContent">
      <!-- Loading indicator -->
      <div *ngIf="isLoadingAnswers" class="text-center mb-3">
        <div class="spinner-border spinner-border-sm me-2" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        Loading answer data...
      </div>
      
      <!-- Main heading from H1 is now shown in the header above, so remove duplicate -->
      
      <div *ngFor="let section of tableData.sections" class="mb-5">
        <!-- Section heading -->
        <h4 *ngIf="section.heading" class="mb-3">{{ section.heading }}</h4>
        
        <!-- Multiple tables in this section -->
        <div *ngFor="let table of section.tables" class="mb-4">
          <table class="table table-bordered custom-table">
            <!-- Table caption -->
            <caption *ngIf="table.caption" class="caption-top fw-bold">{{ table.caption }}</caption>
            
            <thead *ngIf="table.headers && table.headers.length > 0">
              <tr>
                <th *ngFor="let header of table.headers; let headerIndex = index" 
                    class="table-secondary"
                    [attr.colspan]="table.headerSpans && table.headerSpans[headerIndex]?.colspan > 1 ? table.headerSpans[headerIndex].colspan : null"
                    [attr.rowspan]="table.headerSpans && table.headerSpans[headerIndex]?.rowspan > 1 ? table.headerSpans[headerIndex].rowspan : null">
                  {{ header }}
                </th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let row of table.rows">
                <ng-container *ngFor="let cell of row.cells; let cellIndex = index">
                  <td *ngIf="!row.spans || !row.spans[cellIndex]?.isHeader" 
                      [class.fw-bold]="cellIndex === 0"
                      [class.clickable-cell]="isCellClickable(table, row, cellIndex)"
                      [attr.colspan]="row.spans && row.spans[cellIndex]?.colspan > 1 ? row.spans[cellIndex].colspan : null"
                      [attr.rowspan]="row.spans && row.spans[cellIndex]?.rowspan > 1 ? row.spans[cellIndex].rowspan : null"
                      (click)="onCellClick(table, row, cellIndex)">
                    <!-- Simple cell content -->
                    <span *ngIf="!isNestedTable(cell)">{{ cell }}</span>
                    
                    <!-- Nested table content -->
                    <div *ngIf="isNestedTable(cell)" class="nested-table-container">
                      <table class="table table-sm table-bordered mb-0">
                        <thead *ngIf="cell.headers && cell.headers.length > 0">
                          <tr>
                            <th *ngFor="let nestedHeader of cell.headers" class="small table-secondary">{{ nestedHeader }}</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let nestedRow of cell.rows">
                            <td *ngFor="let nestedCell of nestedRow.cells; let nestedCellIndex = index" 
                                [class.fw-bold]="nestedCellIndex === 0" class="small">{{ nestedCell }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </td>
                  
                  <th *ngIf="row.spans && row.spans[cellIndex]?.isHeader" 
                      class="table-secondary"
                      [class.clickable-cell]="isCellClickable(table, row, cellIndex)"
                      [attr.colspan]="row.spans && row.spans[cellIndex]?.colspan > 1 ? row.spans[cellIndex].colspan : null"
                      [attr.rowspan]="row.spans && row.spans[cellIndex]?.rowspan > 1 ? row.spans[cellIndex].rowspan : null"
                      (click)="onCellClick(table, row, cellIndex)">
                    <!-- Simple cell content -->
                    <span *ngIf="!isNestedTable(cell)">{{ cell }}</span>
                    
                    <!-- Nested table content -->
                    <div *ngIf="isNestedTable(cell)" class="nested-table-container">
                      <table class="table table-sm table-bordered mb-0">
                        <thead *ngIf="cell.headers && cell.headers.length > 0">
                          <tr>
                            <th *ngFor="let nestedHeader of cell.headers" class="small table-secondary">{{ nestedHeader }}</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let nestedRow of cell.rows">
                            <td *ngFor="let nestedCell of nestedRow.cells; let nestedCellIndex = index" 
                                [class.fw-bold]="nestedCellIndex === 0" class="small">{{ nestedCell }}</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </th>
                </ng-container>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Fallback to raw HTML if table parsing fails -->
    <ng-template #rawContent>
      <div [innerHTML]="selectedView.content"></div>
    </ng-template>
  </div>

  <!-- Phrases Modal -->
  <div class="modal fade" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'" 
       tabindex="-1" role="dialog" *ngIf="showModal">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{ modalTitle }}</h5>
          <button type="button" class="btn-close" (click)="closeModal()"></button>
        </div>
        <div class="modal-body">
          <div *ngIf="isLoadingPhrases" class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading phrases...</span>
            </div>
            <p class="mt-2">Loading phrases...</p>
          </div>
          
          <div *ngIf="!isLoadingPhrases && modalPhrases.length === 0" class="text-center text-muted">
            No phrases found for this answer.
          </div>
          
          <div *ngIf="!isLoadingPhrases && modalPhrases.length > 0">
            <div class="table-responsive">
              <table class="table table-hover">
                <tbody>
                  <tr *ngFor="let phrase of modalPhrases">
                    <td class="align-middle text-center" style="width: 60px;">
                      <button class="btn btn-outline-secondary" 
                              [disabled]="!phrase.sample || !phrase.phrase_ref"
                              (click)="playAudio(phrase)"
                              title="Play audio"
                              style="width: 40px; height: 40px;">
                        <i class="bi bi-volume-up"></i>
                      </button>
                      <div *ngIf="phrase.phrase_ref">
                        <small class="text-muted">{{ phrase.phrase_ref }}</small>
                      </div>
                    </td>
                    <td class="align-middle">
                      <div class="fw-bold mb-1">{{ phrase.phrase || 'No phrase text' }}</div>
                      <div class="text-muted" *ngIf="phrase.english">{{ phrase.english }}</div>
                      <small class="text-muted fst-italic" *ngIf="phrase.notes">{{ phrase.notes }}</small>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal backdrop -->
  <div class="modal-backdrop fade" [class.show]="showModal" *ngIf="showModal" (click)="closeModal()"></div>

</div>
